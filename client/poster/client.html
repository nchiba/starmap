<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starmap</title>
</head>

<body>
    <table>
        <tr>
            <td>
                <table>
                    <tr>
                        <td></td>
                        <td><input type="button" onclick="javascript:render();" value="Update"></td>
                    </tr>
                    <tr>
                        <td>Boyut</td>
                        <td>
                            <select name="starmap-size" id="starmap-size" onchange="javascript:selectSize();">
                                <option value="sky-poster-230x230" selected="selected">230x230</option>
                                <option value="sky-poster-300x400">300x400</option>
                                <option value="sky-poster-400x500">400x500</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>BG Color</td>
                        <td><input type="text" name="starmap-bg-color" id="starmap-bg-color" value="#ffffff"></td>
                    </tr>
                    <tr>
                        <td>SVG Stars</td>
                        <td><input type="text" name="starmap-bg-svg" id="starmap-bg-svg" value=""></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>BG Url</td>
                        <td><input type="text" name="starmap-bg-url" id="starmap-bg-url" value="bg1.jpg"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="starmap-bg-correction" id="starmap-bg-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td>Correction X</td>
                        <td><input type="text" name="starmap-bg-correction-x" id="starmap-bg-correction-x" value="0">
                        </td>
                    </tr>
                    <tr>
                        <td>Correction Y</td>
                        <td><input type="text" name="starmap-bg-correction-y" id="starmap-bg-correction-y" value="0">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>Frame Enabled</td>
                        <td><input type="text" name="frame-enabled" id="frame-enabled" value="True"></td>
                    </tr>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" name="frame-color" id="frame-color" value="#000000"></td>
                    </tr>
                    <tr>
                        <td>Width</td>
                        <td><input type="text" name="frame-width" id="frame-width" value="5"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="frame-correction" id="frame-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>Text1</td>
                        <td><textarea type="text" name="text-1" id="text-1"></textarea></td>
                    </tr>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" name="text-1-color" id="text-1-color"></td>
                    </tr>
                    <tr>
                        <td>Size</td>
                        <td><input type="text" name="text-1-size" id="text-1-size"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="text-1-correction" id="text-1-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td>Font URL</td>
                        <td><input type="text" name="text-1-font-url" id="text-1-font-url"></td>
                    </tr>
                    <tr>
                        <td>Font Name</td>
                        <td><input type="text" name="text-1-font-name" id="text-1-font-name"></td>
                    </tr>
                    <tr>
                        <td>Font Latin-Ext Woff2</td>
                        <td><input type="text" name="text-1-font-woff" id="text-1-font-woff"></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>Text2</td>
                        <td><textarea type="text" name="text-2" id="text-2"></textarea></td>
                    </tr>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" name="text-2-color" id="text-2-color"></td>
                    </tr>
                    <tr>
                        <td>Size</td>
                        <td><input type="text" name="text-2-size" id="text-2-size"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="text-2-correction" id="text-2-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td>Font URL</td>
                        <td><input type="text" name="text-2-font-url" id="text-2-font-url"></td>
                    </tr>
                    <tr>
                        <td>Font Name</td>
                        <td><input type="text" name="text-2-font-name" id="text-2-font-name"></td>
                    </tr>
                    <tr>
                        <td>Font Latin-Ext Woff2</td>
                        <td><input type="text" name="text-2-font-woff" id="text-2-font-woff"></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>Text3</td>
                        <td><textarea type="text" name="text-3" id="text-3"></textarea></td>
                    </tr>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" name="text-3-color" id="text-3-color"></td>
                    </tr>
                    <tr>
                        <td>Size</td>
                        <td><input type="text" name="text-3-size" id="text-3-size"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="text-3-correction" id="text-3-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td>Font URL</td>
                        <td><input type="text" name="text-3-font-url" id="text-3-font-url"></td>
                    </tr>
                    <tr>
                        <td>Font Name</td>
                        <td><input type="text" name="text-3-font-name" id="text-3-font-name"></td>
                    </tr>
                    <tr>
                        <td>Font Latin-Ext Woff2</td>
                        <td><input type="text" name="text-3-font-woff" id="text-3-font-woff"></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>Text4</td>
                        <td><textarea type="text" name="text-4" id="text-4"></textarea></td>
                    </tr>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" name="text-4-color" id="text-4-color"></td>
                    </tr>
                    <tr>
                        <td>Size</td>
                        <td><input type="text" name="text-4-size" id="text-4-size"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="text-4-correction" id="text-4-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td>Font URL</td>
                        <td><input type="text" name="text-4-font-url" id="text-4-font-url"></td>
                    </tr>
                    <tr>
                        <td>Font Name</td>
                        <td><input type="text" name="text-4-font-name" id="text-4-font-name"></td>
                    </tr>
                    <tr>
                        <td>Font Latin-Ext Woff2</td>
                        <td><input type="text" name="text-4-font-woff" id="text-4-font-woff"></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr />
                        </td>
                    </tr>
                    <tr>
                        <td>Date</td>
                        <td><input type="datetime-local" name="starmap-date" id="starmap-date" value="2020-01-01"></td>
                    </tr>
                    <tr>
                        <td>Sehirler</td>
                        <td>
                            <select name="starmap-cities" id="starmap-cities" onchange="javascript:selectCity();">
                                <option value="" selected="selected">Seçiniz</option>
                                <option value="37.0000 35.3213">Adana (37.0000 35.3213)</option>
                                <option value="37.7648 38.2786">Adıyaman (37.7648 38.2786)</option>
                                <option value="38.7507 30.5567">Afyonkarahisar (38.7507 30.5567)</option>
                                <option value="39.7191 43.0503">Ağrı (39.7191 43.0503)</option>
                                <option value="38.3687 34.0370">Aksaray (38.3687 34.0370)</option>
                                <option value="40.6499 35.8353">Amasya (40.6499 35.8353)</option>
                                <option value="39.9208 32.8541">Ankara (39.9208 32.8541)</option>
                                <option value="36.8841 30.7056">Antalya (36.8841 30.7056)</option>
                                <option value="41.1105 42.7022">Ardahan (41.1105 42.7022)</option>
                                <option value="41.1828 41.8183">Artvin (41.1828 41.8183)</option>
                                <option value="37.8560 27.8416">Aydın (37.8560 27.8416)</option>
                                <option value="39.6484 27.8826">Balıkesir (39.6484 27.8826)</option>
                                <option value="41.5811 32.4610">Bartın (41.5811 32.4610)</option>
                                <option value="37.8812 41.1351">Batman (37.8812 41.1351)</option>
                                <option value="40.2552 40.2249">Bayburt (40.2552 40.2249)</option>
                                <option value="40.0567 30.0665">Bilecik (40.0567 30.0665)</option>
                                <option value="39.0626 40.7696">Bingöl (39.0626 40.7696)</option>
                                <option value="38.3938 42.1232">Bitlis (38.3938 42.1232)</option>
                                <option value="40.5760 31.5788">Bolu (40.5760 31.5788)</option>
                                <option value="37.4613 30.0665">Burdur (37.4613 30.0665)</option>
                                <option value="40.2669 29.0634">Bursa (40.2669 29.0634)</option>
                                <option value="40.1553 26.4142">Çanakkale (40.1553 26.4142)</option>
                                <option value="40.6013 33.6134">Çankırı (40.6013 33.6134)</option>
                                <option value="40.5506 34.9556">Çorum (40.5506 34.9556)</option>
                                <option value="37.7765 29.0864">Denizli (37.7765 29.0864)</option>
                                <option value="37.9144 40.2306">Diyarbakır (37.9144 40.2306)</option>
                                <option value="40.8438 31.1565">Düzce (40.8438 31.1565)</option>
                                <option value="41.6818 26.5623">Edirne (41.6818 26.5623)</option>
                                <option value="38.6810 39.2264">Elâzığ (38.6810 39.2264)</option>
                                <option value="39.7500 39.5000">Erzincan (39.7500 39.5000)</option>
                                <option value="39.9000 41.2700">Erzurum (39.9000 41.2700)</option>
                                <option value="39.7767 30.5206">Eskişehir (39.7767 30.5206)</option>
                                <option value="37.0662 37.3833">Gaziantep (37.0662 37.3833)</option>
                                <option value="40.9128 38.3895">Giresun (40.9128 38.3895)</option>
                                <option value="40.4386 39.5086">Gümüşhane (40.4386 39.5086)</option>
                                <option value="37.5833 43.7333">Hakkâri (37.5833 43.7333)</option>
                                <option value="36.4018 36.3498">Hatay (36.4018 36.3498)</option>
                                <option value="39.8880 44.0048">Iğdır (39.8880 44.0048)</option>
                                <option value="37.7648 30.5566">Isparta (37.7648 30.5566)</option>
                                <option value="41.0053 28.9770">İstanbul (41.0053 28.9770)</option>
                                <option value="38.4189 27.1287">İzmir (38.4189 27.1287)</option>
                                <option value="37.5858 36.9371">Kahramanmaraş (37.5858 36.9371)</option>
                                <option value="41.2061 32.6204">Karabük (41.2061 32.6204)</option>
                                <option value="37.1759 33.2287">Karaman (37.1759 33.2287)</option>
                                <option value="40.6167 43.1000">Kars (40.6167 43.1000)</option>
                                <option value="41.3887 33.7827">Kastamonu (41.3887 33.7827)</option>
                                <option value="38.7312 35.4787">Kayseri (38.7312 35.4787)</option>
                                <option value="36.7184 37.1212">Kilis (36.7184 37.1212)</option>
                                <option value="39.8468 33.5153">Kırıkkale (39.8468 33.5153)</option>
                                <option value="41.7333 27.2167">Kırklareli (41.7333 27.2167)</option>
                                <option value="39.1425 34.1709">Kırşehir (39.1425 34.1709)</option>
                                <option value="40.8533 29.8815">Kocaeli (40.8533 29.8815)</option>
                                <option value="37.8667 32.4833">Konya (37.8667 32.4833)</option>
                                <option value="39.4167 29.9833">Kütahya (39.4167 29.9833)</option>
                                <option value="38.3552 38.3095">Malatya (38.3552 38.3095)</option>
                                <option value="38.6191 27.4289">Manisa (38.6191 27.4289)</option>
                                <option value="37.3212 40.7245">Mardin (37.3212 40.7245)</option>
                                <option value="36.8000 34.6333">Mersin (36.8000 34.6333)</option>
                                <option value="37.2153 28.3636">Muğla (37.2153 28.3636)</option>
                                <option value="38.9462 41.7539">Muş (38.9462 41.7539)</option>
                                <option value="38.6939 34.6857">Nevşehir (38.6939 34.6857)</option>
                                <option value="37.9667 34.6833">Niğde (37.9667 34.6833)</option>
                                <option value="40.9839 37.8764">Ordu (40.9839 37.8764)</option>
                                <option value="37.2130 36.1763">Osmaniye (37.2130 36.1763)</option>
                                <option value="41.0201 40.5234">Rize (41.0201 40.5234)</option>
                                <option value="40.6940 30.4358">Sakarya (40.6940 30.4358)</option>
                                <option value="41.2928 36.3313">Samsun (41.2928 36.3313)</option>
                                <option value="37.1591 38.7969">Şanlıurfa (37.1591 38.7969)</option>
                                <option value="37.9333 41.9500">Siirt (37.9333 41.9500)</option>
                                <option value="42.0231 35.1531">Sinop (42.0231 35.1531)</option>
                                <option value="39.7477 37.0179">Sivas (39.7477 37.0179)</option>
                                <option value="37.4187 42.4918">Şırnak (37.4187 42.4918)</option>
                                <option value="40.9833 27.5167">Tekirdağ (40.9833 27.5167)</option>
                                <option value="40.3167 36.5500">Tokat (40.3167 36.5500)</option>
                                <option value="41.0015 39.7178">Trabzon (41.0015 39.7178)</option>
                                <option value="39.3074 39.4388">Tunceli (39.3074 39.4388)</option>
                                <option value="38.6823 29.4082">Uşak (38.6823 29.4082)</option>
                                <option value="38.4891 43.4089">Van (38.4891 43.4089)</option>
                                <option value="40.6500 29.2667">Yalova (40.6500 29.2667)</option>
                                <option value="39.8181 34.8147">Yozgat (39.8181 34.8147)</option>
                                <option value="41.4564 31.7987">Zonguldak (41.4564 31.7987)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Latitude</td>
                        <td><input type="text" name="starmap-lat" id="starmap-lat" value="41.015137"></td>
                    </tr>
                    <tr>
                        <td>Longitude</td>
                        <td><input type="text" name="starmap-lon" id="starmap-lon" value="28.979530"></td>
                    </tr>
                    <tr>
                        <td>Star Color</td>
                        <td><input type="text" name="starmap-color" id="starmap-color" value="red"></td>
                    </tr>
                    <tr>
                        <td>Elevation</td>
                        <td><input type="number" name="starmap-elevation" id="starmap-elevation" value="0"></td>
                    </tr>
                    <tr>
                        <td>Mag Min</td>
                        <td><input type="number" name="starmap-mag_min" id="starmap-mag_min" value="9"></td>
                    </tr>
                    <tr>
                        <td>Mag Max</td>
                        <td><input type="number" name="starmap-mag_max" id="starmap-mag_max" value="0"></td>
                    </tr>
                    <tr>
                        <td>Frame Enabled</td>
                        <td><input type="text" name="starmap-frame_enabled" id="starmap-frame_enabled" value="True">
                        </td>
                    </tr>
                    <tr>
                        <td>Frame Width</td>
                        <td><input type="number" name="starmap-frame_width" id="starmap-frame_width" value="2"></td>
                    </tr>
                    <tr>
                        <td>Frame Color</td>
                        <td><input type="text" name="starmap-frame_color" id="starmap-frame_color" value="red"></td>
                    </tr>
                    <tr>
                        <td>Sky Culture</td>
                        <td><input type="text" name="starmap-skyculture" id="starmap-skyculture" value="western"></td>
                    </tr>
                    <tr>
                        <td>Correction</td>
                        <td><input type="text" name="starmap-correction" id="starmap-correction" value="0"></td>
                    </tr>
                    <tr>
                        <td>Correction X</td>
                        <td><input type="text" name="starmap-correction-x" id="starmap-correction-x" value="0"></td>
                    </tr>
                    <tr>
                        <td>Correction Y</td>
                        <td><input type="text" name="starmap-correction-y" id="starmap-correction-y" value="0"></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><input type="button" onclick="javascript:render();" value="Update"></td>
                    </tr>
                </table>

            </td>
            <td><canvas width="2717" height="2717" id="sky-poster-230x230"></canvas></td>
            <td><canvas width="3543" height="4724" id="sky-poster-300x400" style="display: none;"></canvas></td>
            <td><canvas width="4724" height="5906" id="sky-poster-400x500" style="display: none;"></canvas></td>
        </tr>
    </table>


    <style>
        * {
            vertical-align: top;
        }

        canvas {
            border: 1px solid gray;
        }

        #sky-poster-230x230 {
            width: 460px;
            height: 460px;
        }

        #sky-poster-300x400 {
            width: 600px;
            height: 800px;
        }

        #sky-poster-400x500 {
            width: 800px;
            height: 1000px;
        }
    </style>
    <script>
        let starmapStorage = window.localStorage;

        loadInputElements(starmapStorage);

        function getStarmapUrl() {
            let url = "https://the-sky-poster.oa.r.appspot.com/?";

            let starmapColor = starmapStorage.getItem("starmap-color");
            url += "&color=" + starmapColor.replace("#", "%23");

            let starmapLat = starmapStorage.getItem("starmap-lat");
            url += "&lat=" + starmapLat;

            let starmapLon = starmapStorage.getItem("starmap-lon");
            url += "&lon=" + starmapLon;

            let starmapDate = starmapStorage.getItem("starmap-date");
            url += "&date=" + starmapDate;

            let starmapElevation = starmapStorage.getItem("starmap-elevation");
            url += "&elevation=" + starmapElevation;

            let starmapMagMin = starmapStorage.getItem("starmap-mag_min");
            url += "&mag_min=" + starmapMagMin;

            let starmapMagMax = starmapStorage.getItem("starmap-mag_max");
            url += "&mag_max=" + starmapMagMax;

            let starmapFrameEnabled = starmapStorage.getItem("starmap-frame_enabled");
            url += "&frame_enabled=" + starmapFrameEnabled;

            let starmapFrameWidth = starmapStorage.getItem("starmap-frame_width");
            url += "&frame_width=" + starmapFrameWidth;

            let starmapFrameColor = starmapStorage.getItem("starmap-frame_color");
            url += "&frame_color=" + starmapFrameColor.replace("#", "%23");

            let starmapSkyculture = starmapStorage.getItem("starmap-skyculture");
            url += "&skyculture=" + starmapSkyculture;

            return url;
        }

        function selectSize() {
            document.getElementById("sky-poster-230x230").style.display = "none";
            document.getElementById("sky-poster-300x400").style.display = "none";
            document.getElementById("sky-poster-400x500").style.display = "none";

            let activeSize = document.getElementById("starmap-size");
            document.getElementById(activeSize.value).style.display = "block";
        }

        function selectCity() {
            let cityElement = document.getElementById("starmap-cities");
            let cityValue = cityElement.value;
            if (cityValue == "") {
                return
            }

            let locationArr = cityValue.split(" ");
            let lat = locationArr[0];
            let lon = locationArr[1];

            document.getElementById("starmap-lat").value = lat;
            document.getElementById("starmap-lon").value = lon;
        }

        function saveInputElements(localStorage) {
            let inputs = document.getElementsByTagName("input");
            for (let index = 0; index < inputs.length; index++) {
                const element = inputs[index];
                localStorage.setItem(element.id, element.value);
            }

            let textareas = document.getElementsByTagName("textarea");
            for (let index = 0; index < textareas.length; index++) {
                const element = textareas[index];
                localStorage.setItem(element.id, element.value);
            }
        }

        function loadInputElements(localStorage) {
            let inputs = document.getElementsByTagName("input");
            for (let index = 0; index < inputs.length; index++) {
                const element = inputs[index];
                element.value = localStorage.getItem(element.id) || element.value;
            }

            let textareas = document.getElementsByTagName("textarea");
            for (let index = 0; index < textareas.length; index++) {
                const element = textareas[index];
                element.value = localStorage.getItem(element.id) || element.value;
            }
        }

        function addCss(fileName) {
            var head = document.head;
            var link = document.createElement("link");

            link.rel = "stylesheet";
            link.href = fileName;

            head.appendChild(link);
        }

        function setText(ctx, width, height, id, y) {
            let url = "https://fonts.googleapis.com/css?family=Rammetto+One"
            let name = 'Rammetto One';
            let woff = "https://fonts.gstatic.com/s/rammettoone/v9/LhWiMV3HOfMbMetJG3lQDppNO_Gduu8.woff2";

            const fontUrl = starmapStorage.getItem(id + "-font-url");
            if (fontUrl != "") {
                const fontName = starmapStorage.getItem(id + "-font-name");
                const fontWoff = starmapStorage.getItem(id + "-font-woff");

                url = fontUrl;
                name = fontName;
                woff = fontWoff;
            }

            addCss(url);
            let f = new FontFace(name, "url('" + woff + "')");
            f.load().then(function () {
                const text = starmapStorage.getItem(id);
                const color = starmapStorage.getItem(id + "-color");
                const size = starmapStorage.getItem(id + "-size");
                const correction = Number(starmapStorage.getItem(id + "-correction"));

                ctx.fillStyle = color;
                ctx.font = size + "px " + name;
                ctx.textAlign = 'center';

                const lines = text.split('\n')
                const dy = y + (width * correction)
                for (let index = 0; index < lines.length; index++) {
                    const line = lines[index];
                    ctx.fillText(line, (width / 2), dy + (Number(size) * index));
                }
            });

        }

        function render() {
            saveInputElements(starmapStorage);
            renderCanvas('sky-poster-230x230', .7, { "text-1": .8, "text-2": .85, "text-3": .9, "text-4": .95, "bg-img-ratio": 1 });
            renderCanvas('sky-poster-300x400', .9, { "text-1": .75, "text-2": .81, "text-3": .87, "text-4": .93, "bg-img-ratio": 1 });
            renderCanvas('sky-poster-400x500', .9, { "text-1": .79, "text-2": .84, "text-3": .89, "text-4": .94, "bg-img-ratio": 1 });
        }

        function renderCanvas(canvasId, imageRatio, options) {
            let cnvs = document.getElementById(canvasId);

            let width = cnvs.width;
            let height = cnvs.height;

            let ctx = cnvs.getContext('2d');
            ctx.clearRect(0, 0, width, height);

            drawSolidBackground(ctx, width, height);
            drawBackgroundImage(ctx, width, height, imageRatio, options);
        }

        function drawPosterElements(ctx, width, height, options) {
            drawPosterFrame(ctx, width, height);
            drawPosterTexts(ctx, width, height, options);
        }

        function drawPosterTexts(ctx, width, height, options) {
            for (const key in options) {
                if (options.hasOwnProperty(key)) {
                    const y = options[key];
                    if (!key.startsWith("text-")) {
                        continue;
                    }
                    setText(ctx, width, height, key, height * y);
                }
            }
        }

        function drawSolidBackground(ctx, width, height) {
            const bgColor = starmapStorage.getItem("starmap-bg-color");

            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, width, height);
        }

        function drawPosterFrame(ctx, width, height) {
            const frameEnabled = starmapStorage.getItem("frame-enabled") == "True"
            if (!frameEnabled) {
                return
            }
            const frameColor = starmapStorage.getItem("frame-color");
            const frameWidth = Number(starmapStorage.getItem("frame-width"));
            const frameCorrection = Number(starmapStorage.getItem("frame-correction"));
            const frameMargin = .02 + frameCorrection;

            ctx.strokeStyle = frameColor;
            ctx.lineWidth = frameWidth;
            ctx.strokeRect(width * frameMargin, height * frameMargin, width * (1 - (2 * frameMargin)), height * (1 - (2 * frameMargin)));
        }

        function drawBackgroundImage(ctx, width, height, imageRatio = 1, options = {}) {
            const bgImg = starmapStorage.getItem("starmap-bg-url");
            if (bgImg == "") {
                drawStarmapImage(ctx, width, height, imageRatio, options);
                return;
            }

            var img = new Image();
            img.onload = function () {
                const marginPercentage = .06;
                const imageCorrection = Number(starmapStorage.getItem("starmap-bg-correction"));
                const imageCorrectionX = Number(starmapStorage.getItem("starmap-bg-correction-x"));
                const imageCorrectionY = Number(starmapStorage.getItem("starmap-bg-correction-y"));

                let imageFixRatio = 1;
                if (options.hasOwnProperty("bg-img-ratio")) {
                    imageFixRatio = options["bg-img-ratio"];
                }
                const scaledWidth = (width * imageRatio) + (width * imageCorrection);
                const fixedWidth = (width * imageRatio * imageFixRatio) + (width * imageCorrection);

                const dx = ((width - scaledWidth) / 2) + (width * imageCorrectionX) + (scaledWidth - fixedWidth) / 2
                const dy = width * marginPercentage + (width * imageCorrectionY) + (scaledWidth - fixedWidth) / 2

                ctx.drawImage(img, dx, dy, fixedWidth, fixedWidth);

                drawStarmapImage(ctx, width, height, imageRatio, options);
            }
            img.src = bgImg;
        }

        function drawStarmapImage(ctx, width, height, imageRatio = 1, options = {}) {
            var img = new Image();
            img.onload = function () {
                const marginPercentage = .06;
                const imageCorrection = Number(starmapStorage.getItem("starmap-correction"));
                const imageCorrectionX = Number(starmapStorage.getItem("starmap-correction-x"));
                const imageCorrectionY = Number(starmapStorage.getItem("starmap-correction-y"));

                const scaledWidth = (width * imageRatio) + (width * imageCorrection);

                const dx = ((width - scaledWidth) / 2) + (width * imageCorrectionX)
                const dy = width * marginPercentage + (width * imageCorrectionY)

                ctx.drawImage(img, dx, dy, scaledWidth, scaledWidth);

                drawPosterElements(ctx, width, height, options);
            }

            let bgSvg = starmapStorage.getItem("starmap-bg-svg");
            if (bgSvg != "") {
                img.src = bgSvg;
            } else {
                img.src = getStarmapUrl();
            }
        }
    </script>
</body>

</html>